{% extends 'agri_market/base.html' %}
{% load custom_filters %}

{% block title %}Mes Commandes Re√ßues - e_agri{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">üì® Commandes Re√ßues</h1>
        <div>
            <a href="{% url 'mes_produits' %}" class="btn btn-outline-primary me-2">
                üì¶ Mes produits
            </a>
            <a href="{% url 'ajouter_produit' %}" class="btn btn-success">
                ‚ûï Ajouter un produit
            </a>
        </div>
    </div>
    
    <!-- Statistiques rapides -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card bg-warning bg-opacity-10 border-0">
                <div class="card-body text-center">
                    <h3 class="mb-0">{{ stats.en_attente }}</h3>
                    <small class="text-muted">En attente</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success bg-opacity-10 border-0">
                <div class="card-body text-center">
                    <h3 class="mb-0">{{ stats.payees }}</h3>
                    <small class="text-muted">Pay√©es</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info bg-opacity-10 border-0">
                <div class="card-body text-center">
                    <h3 class="mb-0">{{ stats.expediees }}</h3>
                    <small class="text-muted">Exp√©di√©es</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-primary bg-opacity-10 border-0">
                <div class="card-body text-center">
                    <h3 class="mb-0">{{ stats.livrees }}</h3>
                    <small class="text-muted">Livr√©es</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filtres -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-4">
                    <select name="statut" class="form-select" onchange="this.form.submit()">
                        <option value="">Tous les statuts</option>
                        <option value="EN_ATTENTE" {% if request.GET.statut == 'EN_ATTENTE' %}selected{% endif %}>
                            En attente
                        </option>
                        <option value="PAYEE" {% if request.GET.statut == 'PAYEE' %}selected{% endif %}>
                            Pay√©es
                        </option>
                        <option value="EXPEDIEE" {% if request.GET.statut == 'EXPEDIEE' %}selected{% endif %}>
                            Exp√©di√©es
                        </option>
                        <option value="LIVREE" {% if request.GET.statut == 'LIVREE' %}selected{% endif %}>
                            Livr√©es
                        </option>
                    </select>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Liste des commandes -->
    {% if commandes %}
        {% for commande_info in commandes %}
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1">Commande #{{ commande_info.commande.id }}</h5>
                        <small class="text-muted">
                            {{ commande_info.commande.date_commande|date:"d/m/Y √† H:i" }}
                        </small>
                    </div>
                    <div>
                        {% if commande_info.commande.statut == 'EN_ATTENTE' %}
                            <span class="badge bg-warning">‚è≥ En attente</span>
                        {% elif commande_info.commande.statut == 'PAYEE' %}
                            <span class="badge bg-success">‚úÖ Pay√©e</span>
                        {% elif commande_info.commande.statut == 'EXPEDIEE' %}
                            <span class="badge bg-info">üöö Exp√©di√©e</span>
                        {% elif commande_info.commande.statut == 'LIVREE' %}
                            <span class="badge bg-primary">üì¶ Livr√©e</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Client:</strong> 
                            {{ commande_info.commande.client.first_name }} 
                            {{ commande_info.commande.client.last_name }}
                        </div>
                        <div class="col-md-6">
                            <strong>üìû Contact:</strong> 
                            {{ commande_info.commande.client.telephone|default:"Non renseign√©" }}
                            | {{ commande_info.commande.client.email }}
                        </div>
                    </div>
                    
                    <h6 class="mb-2">Vos articles dans cette commande:</h6>
                    <ul class="list-unstyled mb-3">
                        {% for ligne in commande_info.mes_lignes %}
                            <li class="d-flex justify-content-between border-bottom py-2">
                                <span>{{ ligne.produit.nom }} x{{ ligne.quantite }}</span>
                                <strong>{{ ligne.prix_unitaire|multiply:ligne.quantite|floatformat:0 }} FCFA</strong>
                            </li>
                        {% endfor %}
                    </ul>
                    
                    <div class="d-flex justify-content-between align-items-center pt-2 border-top">
                        <h6 class="mb-0">Votre montant:</h6>
                        <h5 class="mb-0 text-success">{{ commande_info.mon_total }} FCFA</h5>
                    </div>
                </div>
                
                <div class="card-footer bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        {% if commande_info.commande.statut == 'EN_ATTENTE' %}
                            <small class="text-warning">
                                ‚ö†Ô∏è Nouvelle commande - Contactez le client pour finaliser
                            </small>
                        {% else %}
                            <small class="text-muted">
                                Statut: {{ commande_info.commande.get_statut_display }}
                            </small>
                        {% endif %}
                        
                        <div class="btn-group btn-group-sm">
                            {% if commande_info.commande.statut == 'EN_ATTENTE' %}
                                <form method="POST" action="{% url 'changer_statut_commande' commande_info.commande.id %}" class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="statut" value="PAYEE">
                                    <button type="submit" class="btn btn-success">
                                        ‚úÖ Marquer comme pay√©e
                                    </button>
                                </form>
                            {% elif commande_info.commande.statut == 'PAYEE' %}
                                <form method="POST" action="{% url 'changer_statut_commande' commande_info.commande.id %}" class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="statut" value="EXPEDIEE">
                                    <button type="submit" class="btn btn-info">
                                        üöö Marquer comme exp√©di√©e
                                    </button>
                                </form>
                            {% elif commande_info.commande.statut == 'EXPEDIEE' %}
                                <form method="POST" action="{% url 'changer_statut_commande' commande_info.commande.id %}" class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="statut" value="LIVREE">
                                    <button type="submit" class="btn btn-primary">
                                        üì¶ Marquer comme livr√©e
                                    </button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <div class="card">
            <div class="card-body text-center py-5">
                <div style="font-size: 80px;">üì≠</div>
                <h3 class="mt-3">Aucune commande</h3>
                <p class="text-muted">Vous n'avez pas encore re√ßu de commande</p>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}